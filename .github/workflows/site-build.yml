name: ì‚¬ì´íŠ¸ ë¹Œë“œ ë° ë°°í¬

on:
  schedule:
    - cron: '5 15 * * *'  # ë§¤ì¼ UTC 15:05 (í•œêµ­ì‹œê°„ 00:05)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # ì €ì¥ì†Œì— ì“°ê¸° ê¶Œí•œ í•„ìš”
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: ì‚¬ì´íŠ¸ ë¹Œë“œ
      run: |
        echo "=== íŒŒì¼ ì¡´ì¬ í™•ì¸ ==="
        ls -la *.py
        echo "=== 1. ë²„ìŠ¤ ì‹œê°„í‘œ HTML ìƒì„± ==="
        python app.py
        echo "=== 2. í„°ë¯¸ë„ í—ˆë¸Œ í˜ì´ì§€ ìƒì„± ==="
        if [ -f "hub.py" ]; then
          echo "hub.py íŒŒì¼ ì¡´ì¬í•¨"
          python hub.py
        else
          echo "âŒ hub.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        echo "=== 3. Sitemapê³¼ RSS ìƒì„± ==="
        python sitemap.py
        echo "=== 4. ë¹Œë“œ ì™„ë£Œ ==="
        mkdir -p outputs
        echo "=== outputs í´ë” ìƒì„± í›„ ë‚´ìš© ==="
        ls -la outputs/ || echo "outputs í´ë” ë¹„ì–´ìˆìŒ"
        
    - name: í”Œë ˆì´ìŠ¤í™€ë” ìƒì„± (í•„ìš”ì‹œ)
      run: |
        echo "=== outputs í´ë” ë‚´ìš© ===" 
        ls -la outputs/
        
    - name: íŒŒì¼ì„ rootë¡œ ë³µì‚¬
      run: |
        # outputs í´ë”ì˜ ëª¨ë“  ë‚´ìš© í™•ì¸
        echo "=== outputs í´ë” ì „ì²´ ë‚´ìš© ==="
        ls -la outputs/ 2>/dev/null || echo "outputs í´ë” ì—†ìŒ"
        
        # í„°ë¯¸ë„ í˜ì´ì§€ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸
        echo "=== í„°ë¯¸ë„ í˜ì´ì§€ í™•ì¸ ==="
        ls -la outputs/*-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || echo "í„°ë¯¸ë„ í˜ì´ì§€ ì—†ìŒ"
        
        # íŒŒì¼ë“¤ì„ rootë¡œ ë³µì‚¬ (í„°ë¯¸ë„ í˜ì´ì§€ í¬í•¨)
        cp outputs/*.json . 2>/dev/null || true
        cp outputs/*.xml . 2>/dev/null || true
        cp outputs/*.txt . 2>/dev/null || true
        cp outputs/*-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html . 2>/dev/null || true
        
        # í„°ë¯¸ë„ í˜ì´ì§€ ê°•ì œ ë³µì‚¬ (ì—ëŸ¬ ì²´í¬ í¬í•¨)
        echo "=== í„°ë¯¸ë„ í˜ì´ì§€ ë³µì‚¬ ì‹œì‘ ==="
        if ls outputs/*-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 1> /dev/null 2>&1; then
          cp outputs/*-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html .
          echo "âœ… í„°ë¯¸ë„ í˜ì´ì§€ ë³µì‚¬ ì™„ë£Œ"
          ls -la *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html
        else
          echo "âŒ outputs í´ë”ì— í„°ë¯¸ë„ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤"
          echo "=== outputs í´ë” ì „ì²´ ëª©ë¡ ==="
          ls -la outputs/
          exit 1
        fi
        
        # index.htmlì´ ë³µì‚¬ë˜ì—ˆë‹¤ë©´ ì‚­ì œ
        rm -f index.html 2>/dev/null || true
        
        echo "=== ë³µì‚¬ëœ íŒŒì¼ë“¤ ===" 
        echo "--- ë…¸ì„  ì‹œê°„í‘œ íŒŒì¼ë“¤ ---"
        ls -la *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "ë…¸ì„  í˜ì´ì§€:"
        echo "--- í„°ë¯¸ë„ í—ˆë¸Œ íŒŒì¼ë“¤ ---"
        ls -la *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "í„°ë¯¸ë„ í˜ì´ì§€:"
        echo "--- ê¸°íƒ€ íŒŒì¼ë“¤ ---"
        ls -la *.json *.xml *.txt 2>/dev/null || echo "ê¸°íƒ€ íŒŒì¼ ì—†ìŒ"
        
    - name: ë¹Œë“œ ê²°ê³¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      run: |
        # Git ì„¤ì •
        git config --local user.email "hyunwoohappy@gmail.com"
        git config --local user.name "Hyunwoo0815"
        
        # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
        echo "=== í˜„ì¬ ë¸Œëœì¹˜ ì •ë³´ ==="
        git branch -a
        git status
        
        # ëª¨ë“  ìƒì„±ëœ HTML íŒŒì¼ë“¤ì„ add
        echo "=== ì»¤ë°‹í•  íŒŒì¼ë“¤ í™•ì¸ ==="
        echo "--- ë…¸ì„  ì‹œê°„í‘œ íŒŒì¼ë“¤ ---"
        ls -1 *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "ë…¸ì„  í˜ì´ì§€ ìˆ˜:"
        echo "--- í„°ë¯¸ë„ í—ˆë¸Œ íŒŒì¼ë“¤ ---"  
        ls -1 *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "í„°ë¯¸ë„ í˜ì´ì§€ ìˆ˜:"
        
        # íŒŒì¼ë“¤ì„ ê°•ì œë¡œ add
        echo "=== íŒŒì¼ ì¶”ê°€ ì¤‘ ==="
        git add *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || echo "ë…¸ì„  íŒŒì¼ ì—†ìŒ"
        git add *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || echo "í„°ë¯¸ë„ íŒŒì¼ ì—†ìŒ"  
        git add *.json *.xml *.txt 2>/dev/null || echo "ê¸°íƒ€ íŒŒì¼ ì—†ìŒ"
        
        # ê°•ì œë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì¼ ìƒì„± (ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ë„ ì»¤ë°‹í•˜ê¸° ìœ„í•´)
        echo "Last build: $(date '+%Y-%m-%d %H:%M:%S %Z')" > .build-timestamp
        echo "Build trigger: scheduled" >> .build-timestamp
        git add .build-timestamp
        
        echo "=== git status (after add) ==="
        git status
        echo "=== staged files ==="
        git diff --staged --name-only
        
        # ì»¤ë°‹ ë° í‘¸ì‹œ (í•­ìƒ ì‹¤í–‰)
        echo "=== ì»¤ë°‹ ì§„í–‰ ==="
        git commit -m "ğŸš€ Daily site update [$(date '+%Y-%m-%d %H:%M:%S')] 
        
        ğŸ“Š Generated files:
        - Route pages: $(ls -1 *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l)
        - Terminal pages: $(ls -1 *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l)  
        - Other files: $(ls -1 *.json *.xml *.txt 2>/dev/null | wc -l)
        
        ğŸ• Auto-triggered at KST 00:05"
        
        echo "=== í‘¸ì‹œ ì§„í–‰ ==="
        git push origin main --verbose
        
        echo "=== í‘¸ì‹œ ì™„ë£Œ í™•ì¸ ==="
        git log --oneline -1
