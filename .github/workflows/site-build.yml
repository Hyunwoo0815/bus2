name: ì‚¬ì´íŠ¸ ë¹Œë“œ ë° ë°°í¬

on:
  push:
    branches: [ main ]
    paths:
      - 'data/*.json'
      - 'app.py'
      - 'route/*.json'
      - '.github/workflows/**'
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ì˜¤ì „ 11ì‹œ (í•œêµ­ì‹œê°„ UTC+9)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: ì‚¬ì´íŠ¸ ë¹Œë“œ
      run: |
        echo "=== íŒŒì¼ ì¡´ì¬ í™•ì¸ ==="
        ls -la *.py
        echo "=== 1. ë²„ìŠ¤ ì‹œê°„í‘œ HTML ìƒì„± ==="
        python app.py
        echo "=== 2. í„°ë¯¸ë„ í—ˆë¸Œ í˜ì´ì§€ ìƒì„± ==="
        if [ -f "hub.py" ]; then
          echo "hub.py íŒŒì¼ ì¡´ì¬í•¨"
          python hub.py
        else
          echo "âŒ hub.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        echo "=== 3. Sitemapê³¼ RSS ìƒì„± ==="
        python sitemap.py
        echo "=== 4. ë¹Œë“œ ì™„ë£Œ ==="
        mkdir -p outputs
        echo "=== outputs í´ë” ìƒì„± í›„ ë‚´ìš© ==="
        ls -la outputs/ || echo "outputs í´ë” ë¹„ì–´ìˆìŒ"
        
    - name: í”Œë ˆì´ìŠ¤í™€ë” ìƒì„± (í•„ìš”ì‹œ)
      run: |
        echo "=== outputs í´ë” ë‚´ìš© ===" 
        ls -la outputs/
        
    - name: íŒŒì¼ì„ rootë¡œ ë³µì‚¬
      run: |
        # outputs í´ë”ì˜ ëª¨ë“  ë‚´ìš© í™•ì¸
        echo "=== outputs í´ë” ì „ì²´ ë‚´ìš© ==="
        ls -la outputs/ 2>/dev/null || echo "outputs í´ë” ì—†ìŒ"
        
        # í„°ë¯¸ë„ í˜ì´ì§€ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸
        echo "=== í„°ë¯¸ë„ í˜ì´ì§€ í™•ì¸ ==="
        ls -la outputs/*-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || echo "í„°ë¯¸ë„ í˜ì´ì§€ ì—†ìŒ"
        
        # íŒŒì¼ë“¤ì„ rootë¡œ ë³µì‚¬
        cp outputs/*.json . 2>/dev/null || true
        cp outputs/*.xml . 2>/dev/null || true
        cp outputs/*.txt . 2>/dev/null || true
        cp outputs/*-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html . 2>/dev/null || true
        
        # index.htmlì´ ë³µì‚¬ë˜ì—ˆë‹¤ë©´ ì‚­ì œ
        rm -f index.html 2>/dev/null || true
        
        echo "=== ë³µì‚¬ëœ íŒŒì¼ë“¤ ===" 
        echo "--- ë…¸ì„  ì‹œê°„í‘œ íŒŒì¼ë“¤ ---"
        ls -la *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "ë…¸ì„  í˜ì´ì§€:"
        echo "--- í„°ë¯¸ë„ í—ˆë¸Œ íŒŒì¼ë“¤ ---"
        ls -la *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "í„°ë¯¸ë„ í˜ì´ì§€:"
        echo "--- ê¸°íƒ€ íŒŒì¼ë“¤ ---"
        ls -la *.json *.xml *.txt 2>/dev/null || echo "ê¸°íƒ€ íŒŒì¼ ì—†ìŒ"
        
    - name: ë¹Œë“œ ê²°ê³¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      run: |
        git config --local user.email "hyunwoohappy@gmail.com"
        git config --local user.name "Hyunwoo0815"
        
        # ëª¨ë“  ìƒì„±ëœ HTML íŒŒì¼ë“¤ì„ add
        echo "=== ì»¤ë°‹í•  íŒŒì¼ë“¤ í™•ì¸ ==="
        echo "--- ë…¸ì„  ì‹œê°„í‘œ íŒŒì¼ë“¤ ---"
        ls -1 *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "ë…¸ì„  í˜ì´ì§€ ìˆ˜:"
        echo "--- í„°ë¯¸ë„ í—ˆë¸Œ íŒŒì¼ë“¤ ---"  
        ls -1 *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null | wc -l | xargs echo "í„°ë¯¸ë„ í˜ì´ì§€ ìˆ˜:"
        
        # ìƒì„±ëœ íŒŒì¼ë“¤ë§Œ ì„ íƒì ìœ¼ë¡œ add (index.htmlê³¼ CNAME ë“± ì œì™¸)
        git add *-ì—ì„œ-*-ê°€ëŠ”-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || true
        git add *-í„°ë¯¸ë„-ì‹œì™¸ë²„ìŠ¤-ì‹œê°„í‘œ.html 2>/dev/null || true
        git add *.json *.xml *.txt 2>/dev/null || true
        
        echo "=== git status ==="
        git status
        echo "=== staged files ==="
        git diff --staged --name-only
        
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          git commit -m "ğŸš€ Auto-generated site files [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push
        fi
