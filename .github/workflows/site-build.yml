name: 사이트 빌드 및 배포

on:
  schedule:
    - cron: '5 15 * * *'  # 매일 UTC 15:05 (한국시간 00:05)
  workflow_dispatch:  # 수동 실행 가능

permissions:
  contents: write  # 저장소에 쓰기 권한 필요
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: Python 설정
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 의존성 설치
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: 사이트 빌드
      run: |
        echo "=== 파일 존재 확인 ==="
        ls -la *.py
        echo "=== 1. 버스 시간표 HTML 생성 ==="
        python app.py
        echo "=== 2. 터미널 허브 페이지 생성 ==="
        if [ -f "hub.py" ]; then
          echo "hub.py 파일 존재함"
          python hub.py
        else
          echo "❌ hub.py 파일이 없습니다"
          exit 1
        fi
        echo "=== 3. Sitemap과 RSS 생성 ==="
        python sitemap.py
        echo "=== 4. 빌드 완료 ==="
        mkdir -p outputs
        echo "=== outputs 폴더 생성 후 내용 ==="
        ls -la outputs/ || echo "outputs 폴더 비어있음"
        
    - name: 플레이스홀더 생성 (필요시)
      run: |
        echo "=== outputs 폴더 내용 ===" 
        ls -la outputs/
        
    - name: 파일을 root로 복사
      run: |
        # outputs 폴더의 모든 내용 확인
        echo "=== outputs 폴더 전체 내용 ==="
        ls -la outputs/ 2>/dev/null || echo "outputs 폴더 없음"
        
        # 터미널 페이지들이 있는지 확인
        echo "=== 터미널 페이지 확인 ==="
        ls -la outputs/*-터미널-시외버스-시간표.html 2>/dev/null || echo "터미널 페이지 없음"
        
        # 파일들을 root로 복사 (터미널 페이지 포함)
        cp outputs/*.json . 2>/dev/null || true
        cp outputs/*.xml . 2>/dev/null || true
        cp outputs/*.txt . 2>/dev/null || true
        cp outputs/*-에서-*-가는-시외버스-시간표.html . 2>/dev/null || true
        
        # 터미널 페이지 강제 복사 (에러 체크 포함)
        echo "=== 터미널 페이지 복사 시작 ==="
        if ls outputs/*-터미널-시외버스-시간표.html 1> /dev/null 2>&1; then
          cp outputs/*-터미널-시외버스-시간표.html .
          echo "✅ 터미널 페이지 복사 완료"
          ls -la *-터미널-시외버스-시간표.html
        else
          echo "❌ outputs 폴더에 터미널 페이지가 없습니다"
          echo "=== outputs 폴더 전체 목록 ==="
          ls -la outputs/
          exit 1
        fi
        
        # index.html이 복사되었다면 삭제
        rm -f index.html 2>/dev/null || true
        
        echo "=== 복사된 파일들 ===" 
        echo "--- 노선 시간표 파일들 ---"
        ls -la *-에서-*-가는-시외버스-시간표.html 2>/dev/null | wc -l | xargs echo "노선 페이지:"
        echo "--- 터미널 허브 파일들 ---"
        ls -la *-터미널-시외버스-시간표.html 2>/dev/null | wc -l | xargs echo "터미널 페이지:"
        echo "--- 기타 파일들 ---"
        ls -la *.json *.xml *.txt 2>/dev/null || echo "기타 파일 없음"
        
    - name: 빌드 결과 커밋 및 푸시
      run: |
        # Git 설정
        git config --local user.email "hyunwoohappy@gmail.com"
        git config --local user.name "Hyunwoo0815"
        
        # 현재 브랜치 확인
        echo "=== 현재 브랜치 정보 ==="
        git branch -a
        git status
        
        # 모든 생성된 HTML 파일들을 add
        echo "=== 커밋할 파일들 확인 ==="
        echo "--- 노선 시간표 파일들 ---"
        ls -1 *-에서-*-가는-시외버스-시간표.html 2>/dev/null | wc -l | xargs echo "노선 페이지 수:"
        echo "--- 터미널 허브 파일들 ---"  
        ls -1 *-터미널-시외버스-시간표.html 2>/dev/null | wc -l | xargs echo "터미널 페이지 수:"
        
        # 파일들을 강제로 add
        echo "=== 파일 추가 중 ==="
        git add *-에서-*-가는-시외버스-시간표.html 2>/dev/null || echo "노선 파일 없음"
        git add *-터미널-시외버스-시간표.html 2>/dev/null || echo "터미널 파일 없음"  
        git add *.json *.xml *.txt 2>/dev/null || echo "기타 파일 없음"
        
        # 강제로 타임스탬프 파일 생성 (변경사항이 없어도 커밋하기 위해)
        echo "Last build: $(date '+%Y-%m-%d %H:%M:%S %Z')" > .build-timestamp
        echo "Build trigger: scheduled" >> .build-timestamp
        git add .build-timestamp
        
        echo "=== git status (after add) ==="
        git status
        echo "=== staged files ==="
        git diff --staged --name-only
        
        # 커밋 및 푸시 (항상 실행)
        echo "=== 커밋 진행 ==="
        git commit -m "🚀 Daily site update [$(date '+%Y-%m-%d %H:%M:%S')] 
        
        📊 Generated files:
        - Route pages: $(ls -1 *-에서-*-가는-시외버스-시간표.html 2>/dev/null | wc -l)
        - Terminal pages: $(ls -1 *-터미널-시외버스-시간표.html 2>/dev/null | wc -l)  
        - Other files: $(ls -1 *.json *.xml *.txt 2>/dev/null | wc -l)
        
        🕐 Auto-triggered at KST 00:05"
        
        echo "=== 푸시 진행 ==="
        git push origin main --verbose
        
        echo "=== 푸시 완료 확인 ==="
        git log --oneline -1
